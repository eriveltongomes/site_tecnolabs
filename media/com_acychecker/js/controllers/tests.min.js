"use strict";function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,s){for(var t=0;t<s.length;t++){var a=s[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,s,t){return s&&_defineProperties(e.prototype,s),t&&_defineProperties(e,t),e}var AcycTests=function(){function e(){_classCallCheck(this,e),ListingService.initOrdering(),ListingService.setCheckAll(),ListingService.setCheckboxesActions(),ListingService.setSelectActions(),ListingService.setActionButtons(),this.setMatchingUsersCounter(),this.setHandleResults()}return _createClass(e,[{key:"setHandleResults",value:function(){var e=this;jQuery('[data-open="acycmodal_handle_modal"]').on("click",function(){jQuery('[name^="acyc_config[conditions_selected]"]').trigger("change")}),jQuery("#acyc__tests__handle__process").off("click").on("click",function(){var s=jQuery('input[name^="acyc_config[tables_selected]"]:checked');if(0!==s.length){var t=[];s.each(function(){t.push(jQuery(this).val())});var a=jQuery('input[name^="acyc_config[conditions_selected]"]:checked');if(0!==a.length){var c=[];a.each(function(){c.push(jQuery(this).val())}),confirm(ACYC_LANGUAGES.ACYC_LAST_CONFIRMATION)&&e.rerunResultsHandling({page:"acychecker_tests",ctrl:"tests",task:"ajaxHandleResults",userTables:t.join(","),userAction:jQuery('input[name="acyc_config[action_selected]"]:checked').val(),actionConditions:c.join(","),start:0,limit:5e3})}else alert(ACYC_LANGUAGES.ACYC_PLEASE_SELECT_A_CONDITION)}else alert(ACYC_LANGUAGES.ACYC_NO_USER_TABLE_SELECTED)})}},{key:"displayMessage",value:function(e,s){var t=jQuery("#acyc__tests__handle__message");jQuery("#acyc__tests__handle__message__message").html(e),jQuery("#acyc__tests__handle__progressbar").addClass("is-hidden"),"error"===s?(t.find(".acyc_green").addClass("is-hidden"),t.find(".acyc_red").removeClass("is-hidden")):(t.find(".acyc_green").removeClass("is-hidden"),t.find(".acyc_red").addClass("is-hidden")),t.removeClass("is-hidden")}},{key:"rerunResultsHandling",value:function(e){var s=this;jQuery("#acyc__tests__handle__message").addClass("is-hidden"),this.$counter=jQuery(".progress-counter"),this.$counter.html("0%"),this.$meter=jQuery(".progress-meter"),this.$meter.animate({width:"0"},400),this.percentage=0,this.totalHandledResults=0,this.totalModifiedUsers=0,jQuery("#acyc__tests__handle__progressbar").removeClass("is-hidden");var t=jQuery('[name="elements_checked[]"]:checked');if(t.length>0){if(e.selectedUsers=[],t.each(function(){"true"===jQuery(this).attr("data-acyc-finished")&&e.selectedUsers.push(jQuery(this).val())}),0===e.selectedUsers.length)return void this.displayMessage(ACYC_LANGUAGES.ACYC_SELECT_FINISHED_TESTS,"error");this.totalResults=e.selectedUsers.length,this.handleNextBatch(e)}else AjaxService.post(ACYC_AJAX_URL,{page:"acychecker_tests",ctrl:"tests",task:"ajaxGetTotalResults"}).then(function(t){"success"===t.status?(s.totalResults=parseInt(t.data.totalResults),s.handleNextBatch(e)):s.displayMessage(t.message,"error")})}},{key:"handleNextBatch",value:function(e){var s=this;AjaxService.post(ACYC_AJAX_URL,e).then(function(t){if("success"===t.status)if(s.totalHandledResults+=t.data.handledResults,s.totalModifiedUsers+=t.data.usersChanged,s.percentage=Math.round(100*s.totalHandledResults/s.totalResults),s.$counter.html("".concat(s.percentage,"%")),s.$meter.animate({width:"".concat(s.percentage,"%")},400),s.totalHandledResults<s.totalResults)e.start+=e.limit,s.handleNextBatch(e);else{var a="";a="block_users"===e.userAction?ACYC_LANGUAGES.ACYC_USERS_BLOCKED:ACYC_LANGUAGES.ACYC_USERS_DELETED,s.displayMessage(a.replace("%s",s.totalModifiedUsers),"success");var c=jQuery("#acyc__tests__handle__progressbar").closest(".reveal-overlay");c.find(".close-button").on("click",function(){location.reload()}),c.on("click",function(){location.reload()}),c.find(".reveal").on("click",function(e){e.stopPropagation()})}else s.displayMessage(t.message,"error")})}},{key:"setConditionsMessage",value:function(e){var s=jQuery("#acyc__tests__handle__selected_users"),t=jQuery('[name="elements_checked[]"]:checked');t.length>0?s.html(ACYC_LANGUAGES.ACYC_ACTIONS_EXECUTED_X_MATCHING_AMONG_SELECTED.replace("%1$s","<b>".concat(e,"</b>")).replace("%2$s",t.length)):s.html(ACYC_LANGUAGES.ACYC_ACTIONS_EXECUTED_X_MATCHING.replace("%s","<b>".concat(e,"</b>")))}},{key:"setMatchingUsersCounter",value:function(){var e=this;jQuery('[name^="acyc_config[conditions_selected]"]').on("change",function(){var s=jQuery('input[name^="acyc_config[conditions_selected]"]:checked'),t=jQuery('[name="elements_checked[]"]:checked');if(0===s.length)e.setConditionsMessage(0);else{e.setConditionsMessage('<i class="acycicon-circle-o-notch acycicon-spin"></i>');var a=[];s.each(function(){a.push(jQuery(this).val())});var c={page:"acychecker_tests",ctrl:"tests",task:"ajaxGetNbMatchingUsers",actionConditions:a.join(",")};t.length>0&&(c.selectedUsers=[],t.each(function(){"true"===jQuery(this).attr("data-acyc-finished")&&c.selectedUsers.push(jQuery(this).val())})),AjaxService.post(ACYC_AJAX_URL,c).then(function(s){"success"===s.status?e.setConditionsMessage(s.data.matchingUsersNb):e.displayMessage(s.message,"error")})}})}}]),e}();jQuery(function(){new AcycTests});